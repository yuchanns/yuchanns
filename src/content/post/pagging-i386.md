---
title: "分页的概念与 i386 的实现"
date: 2021-08-15T22:13:39+08:00
draft: false
---
> 理论结合实践，学习《操作系统概念》之分页(**pagging**)。

## 概念
* 帧(**frame**) - 物理内存分为固定大小的块
* 帧表(**frame table**) - 记录帧的信息
* 页(**page**) - 逻辑内存分为与帧同样大小的块
* 页表(**page table**) - 记录页的信息
* 页码(**page number**) - 页表的索引
* 页偏移(**page offset**) - 页内的偏移地址

页的大小为2的幂，方便将逻辑地址转换为页码和页偏移。

逻辑地址空间为 $2^m$ ，且页的大小为 $2^n$ ，则逻辑地址的高 $m-n$ 位表示页码 ，低 $n$ 位表示页偏移。

![](/images/pagging-01.png)

对于32位硬件来说，其逻辑地址空间为 $2^{32}$ ，页的大小(通常)为 4kb 即 $2^{12}$ ，因此使用高20位表示页码，低12位表示偏移，系统可访问 $2^{44}$ 字节大小的物理内存。

分页不会产生外部碎片，但是有内部碎片。

一般意义上，逻辑地址被分解成页码和页偏移，通过页表查找到页码对应的页，然后根据页上保存的物理地址加上页偏移访问物理内存。

![](/images/pagging-02.png)

## 硬件支持
分页功能依赖于硬件的支持。

* 页表专用寄存器: 适合小条目页表(eg: **DEC PDP-11**)
* 页表基地址寄存器(**PTBR**): 页表放在内存中，适合大条目页表

**转换表缓冲区 TLB**

使用 **PTBR** 获取真实物理地址需要访问两次内存，内存访问速度减半，延迟提高。因此需要引入专用的小型高速硬件缓冲(**Translation Look-aside Buffer**)。

TLB 包含少数页表条目，逻辑地址首先从 TLB 查找页码。未找到被称为 **TLB miss** ，则进行两次内存访问，并把结果保存到 TLB 。

查找页表条目中在 TLB 命中次数的百分比称为**命中率**。可以通过加权计算获得**有效内存访问时间**：
> 设 TLB 命中率为99%。当页码在 TLB 中时，访问内存需要 $100ns$ 。如果未命中，访问页表花费 $100ns$ ， 访问内存花费 $100ns$ ，则有效内存访问时间 $= 0.99\times100+0.01\times200 = 101ns$

## 页表结构
对于32位逻辑地址空间的系统来说，当页大小为 4kb 时，页表多达 $2^{32}/2^{12} = 2^{20}$ 即1048576条，每个条目占 4byte 内存，则页表大小为 4mb 。

需要将页表划分为更小的块避免连续分配大内存。

**分层分页**

对页表进行两层分页，使用逻辑的地址的高10位作为**外层页表**的索引，中10位作为**内层页表**的索引，低12位作为页偏移。

![](/images/pagging-03.png)

对于64位则可以使用四层分页。

**哈希页表**

## i386 的分页实现
